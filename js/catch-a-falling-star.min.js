var XMing=XMing||{};XMing.GameStateManager=new function(){var j;var e;var b;var a;var k;var m=[];var i=[];var h=[];var f=0;var d;var g=30;var c={};var l={INITIAL:"initial",START:"start",PAUSE:"pause",END:"end"};this.init=function(){e=document.getElementById("canvas");b=e.getContext("2d");e.addEventListener("mousemove",this.onMouseMove.bind(this),false);e.addEventListener("touchmove",this.onMouseMove.bind(this),false);e.addEventListener("click",this.onClick.bind(this),false);window.addEventListener("keydown",this.onKeyDown.bind(this),false);window.addEventListener("resize",this.resizeCanvas.bind(this),false);var s=new Image();s.src="images/character.png";c.character=s;var r=new Image();r.src="images/character-left.png";c["character-left"]=r;var q=new Image();q.src="images/character-right.png";c["character-right"]=q;var o=new Image();o.src="images/twinkle-star.png";c["twinkle-star"]=o;var p=new Image();p.src="images/falling-star.png";c["falling-star"]=p;var n=new Image();n.src="images/star-with-border.png";c["star-with-border"]=n;this.initGame();this.update()};this.update=function(){j=requestAnimFrame(this.update.bind(this));if(this.isGameStateStart()){if(g<=0){this.endGame()}k.update();m=_.filter(m,function(){return _.random(200)!=50});for(var n=0;n<100;n++){if(_.random(200)==50){m.push(new XMing.TwinkleStar(e))}}i=_.filter(i,function(o){return !o.isGone&&!o.isCaught});if(_.random(50)==25){i.push(new XMing.FallingStar(e))}h=_.filter(h,function(o){return o.alpha>0});_.each(h,function(o){o.update()});_.each(i,function(o){o.update();if(!o.isStopped&&o.x>=k.x-k.width/2&&o.x<=k.x+k.width/2&&o.y>=k.y-k.height/2&&o.y<=k.y+k.height/2){o.isCaught=true;h.push(new XMing.Message(k.x,k.y-k.height/2,e.width/30));f++}})}else{if(this.isGameStateEnd()){h=_.filter(h,function(o){return o.alpha>0});_.each(h,function(o){o.update()})}}this.render()};this.render=function(){b.clearRect(0,0,e.width,e.height);if(this.isGameStateStart()||this.isGameStateEnd()){k.render(b);_.each(i,function(o){o.render(b)});_.each(m,function(o){o.render(b)});_.each(h,function(o){o.render(b)});b.save();b.fillStyle="white";var n=e.height/10*9;b.fillRect(0,n,e.width,e.height-n);b.restore();this.renderTime();this.renderScore()}if(this.isGameStateEnd()){b.save();b.fillStyle="rgba(0,0,0,.5)";b.fillRect(0,0,e.width,e.height);b.fillStyle="rgba(255,255,255,.5)";b.fillRect(e.width/8,e.height/8,e.width/8*6,e.height/8*6);b.font=e.width/4*2/12+"pt Calibri";b.textAlign="center";b.textBaseline="middle";b.fillStyle="black";b.wrapText("\nCongratulations! \n You have collected "+f+" stars!\n Try again!",e.width/2,e.height/8,e.width/8*6,e.height/8*6/4);b.restore()}};this.renderTime=function(){b.save();b.font=e.width/20+"pt Calibri";b.textAlign="left";b.textBaseline="top";b.fillStyle="white";b.fillText("Time left: "+g,10,0);b.restore()};this.renderScore=function(){b.save();var n=new Image();n.src="images/falling-star.png";b.translate(e.width/20*17,e.width/20/3);b.drawImage(n,0,0,e.width/20,e.width/20);b.translate(e.width/20,-e.width/20/3);b.font=e.width/20+"pt Calibri";b.textAlign="left";b.textBaseline="top";b.fillStyle="white";b.fillText(":",0,0);b.translate(e.width/20/2,0);b.textAlign="left";b.fillText(""+f,0,0);b.restore()};this.onKeyDown=function(o){var n=o.charCode||o.keyCode;if(n>=47&&n<=90){n=decodeURI("%"+(n).toString(16)).toLowerCase()}if(this.isGameStateInitial()||this.isGameStateEnd()){if(n==13){this.startGame()}}else{if(this.isGameStateStart()){if(n==37){if(k.x-30*k.velocityX<k.width/2){k.targetX=k.width/2}else{k.targetX=k.x-30*k.velocityX}}if(n==39){if(k.x+30*k.velocityX>e.width-k.width/2){k.targetX=e.width-k.width/2}else{k.targetX=k.x+30*k.velocityX}}}}};this.onMouseMove=function(o){if(this.isGameStateStart()){var n=this.getMousePos(o);if(n.x<k.width/2){k.targetX=k.width/2}else{if(n.x>e.width-k.width/2){k.targetX=e.width-k.width/2}else{k.targetX=n.x}}}};this.onTouchStart=function(n){};this.onClick=function(o){var n=this.getMousePos(o);if(this.isGameStateStart()){if(n.x<k.width/2){k.targetX=k.width/2}else{if(n.x>e.width-k.width/2){k.targetX=e.width-k.width/2}else{k.targetX=n.x}}}if(this.isGameStateInitial()||this.isGameStateEnd()){if(n.x>=e.width/4&&n.x<=e.width/4*3&&n.y>=e.height/4&&n.y<=e.height/4*3){this.startGame()}}};this.getMousePos=function(o){var n=e.getBoundingClientRect();return{x:o.clientX-n.left,y:o.clientY-n.top}};this.resizeCanvas=function(){var p=e.clientWidth;var o=e.clientHeight;if(e.width!=p||e.height!=o){var n=p/e.width;var q=o/e.height;e.width=p;e.height=o;if(k!=null){k.resize(e,n,q)}_.each(i,function(r){r.resize(n,q)});_.each(m,function(r){r.resize(n,q)});_.each(h,function(r){r.resize(n,q)})}};this.getImage=function(n){return c[n]};this.initGame=function(){a=l.INITIAL};this.startGame=function(){a=l.START;this.resizeCanvas();k=new XMing.Character(e);m=[];while(m.length<50){m.push(new XMing.TwinkleStar(e))}i=[];h=[];f=0;g=30;d=setInterval(function(){g--},1000)};this.endGame=function(){a=l.END;k.targetX=k.x;clearInterval(d);d=null};this.isGameStateInitial=function(){return a==l.INITIAL};this.isGameStateStart=function(){return a==l.START};this.isGameStateEnd=function(){return a==l.END}};XMing.Character=function(a){this.x=a.width/2;this.y=a.height/10*9-a.width/12/2;this.targetX=this.x;this.width=a.width/12;this.height=a.width/12;this.velocityX=a.width/300;this.isStepped=false;this.timer=0};XMing.Character.prototype.resize=function(b,a,c){console.log(a+", "+c);this.x*=a;this.y=b.height/10*9-b.width/12/2;this.targetX*=a;this.width*=a;this.height=this.width;this.velocityX*=a};XMing.Character.prototype.update=function(){if(this.x<this.targetX){if(this.x+this.velocityX>this.targetX){this.x=this.targetX}else{this.x+=this.velocityX}}if(this.x>this.targetX){if(this.x-this.velocityX<this.targetX){this.x=this.targetX}else{this.x-=this.velocityX}}};XMing.Character.prototype.render=function(c){c.save();var b;var a=10;if(this.x>this.targetX||this.x<this.targetX){this.timer++;if(this.timer>a){this.timer/=a;this.isStepped=!this.isStepped}if(this.isStepped){b=XMing.GameStateManager.getImage("character-left")}else{b=XMing.GameStateManager.getImage("character-right")}}else{b=XMing.GameStateManager.getImage("character")}c.translate(this.x,this.y);c.drawImage(b,-this.width/2,-this.height/2,this.width,this.height);c.restore()};XMing.TwinkleStar=function(b){var a=_.random(b.width/20);this.x=_.random(b.width);this.y=_.random(b.height/10*4);this.width=a;this.height=a};XMing.TwinkleStar.prototype.resize=function(a,b){this.x*=a;this.y*=b;this.width*=a;this.height=this.width};XMing.TwinkleStar.prototype.update=function(){};XMing.TwinkleStar.prototype.render=function(b){b.save();var a=XMing.GameStateManager.getImage("twinkle-star");b.globalAlpha=_.random(0.5,1);b.translate(this.x,this.y);b.drawImage(a,-this.width/2,-this.height/2,this.width,this.height);b.restore()};XMing.FallingStar=function(a){var b=_.random(10,a.width/20);this.x=_.random(b/2,a.width-b/2);this.y=_.random(a.height/10,a.height/10*2);this.width=b;this.height=b;this.velocityY=_.random(2,a.height/200);this.destY=a.height/10*9-this.height/2;this.isCaught=false;this.isStopped=false;this.isGone=false;this.rotateAngle=0};XMing.FallingStar.prototype.resize=function(a,b){this.x*=a;this.y*=b;this.width*=a;this.height=this.width;this.velocityY*=b};XMing.FallingStar.prototype.update=function(){if(this.y<this.destY){if(this.y+this.velocityY>=this.destY){this.y=this.destY;this.isStopped=true}else{this.y+=this.velocityY;this.rotateAngle+=2*Math.PI/180}}};XMing.FallingStar.prototype.render=function(b){if(!this.isCaught){b.save();b.translate(this.x,this.y);b.rotate(this.rotateAngle);var a;if(this.isStopped){b.globalAlpha=0.5;a=XMing.GameStateManager.getImage("star-with-border")}else{a=XMing.GameStateManager.getImage("falling-star")}b.drawImage(a,-this.width/2,-this.height/2,this.width,this.height);b.restore()}};XMing.Message=function(a,c,b){this.x=a;this.y=c;this.text="+ 1";this.alpha=1;this.fontSize=b};XMing.Message.prototype.resize=function(a,b){this.x*=a;this.y*=b;this.fontSize*=a};XMing.Message.prototype.update=function(){this.y--;this.alpha-=0.01};XMing.Message.prototype.render=function(a){if(this.alpha>0){a.save();a.globalAlpha=this.alpha;a.font=this.fontSize+"pt Calibri";a.textAlign="left";a.textBaseline="bottom";a.fillStyle="white";a.fillText(this.text,this.x,this.y);a.restore()}};